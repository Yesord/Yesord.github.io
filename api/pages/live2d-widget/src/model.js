{"title":"","type":"page","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"import showMessage from \"./message.js\"; import randomSelection from \"./utils.js\"; class Model { constructor(config) { let { apiPath, cdnPath...","date":"2024-11-03T04:51:55.747Z","updated":"2024-11-03T04:51:55.747Z","comments":true,"path":"api/pages/live2d-widget/src/model.js","covers":null,"excerpt":"","content":"import showMessage from \"./message.js\";\nimport randomSelection from \"./utils.js\";\n\nclass Model {\n    constructor(config) {\n        let { apiPath, cdnPath } = config;\n        let useCDN = false;\n        if (typeof cdnPath === \"string\") {\n            useCDN = true;\n            if (!cdnPath.endsWith(\"/\")) cdnPath += \"/\";\n        } else if (typeof apiPath === \"string\") {\n            if (!apiPath.endsWith(\"/\")) apiPath += \"/\";\n        } else {\n            throw \"Invalid initWidget argument!\";\n        }\n        this.useCDN = useCDN;\n        this.apiPath = apiPath;\n        this.cdnPath = cdnPath;\n    }\n\n    async loadModelList() {\n        const response = await fetch(`${this.cdnPath}model_list.json`);\n        this.modelList = await response.json();\n    }\n\n    async loadModel(modelId, modelTexturesId, message) {\n        localStorage.setItem(\"modelId\", modelId);\n        localStorage.setItem(\"modelTexturesId\", modelTexturesId);\n        showMessage(message, 4000, 10);\n        if (this.useCDN) {\n            if (!this.modelList) await this.loadModelList();\n            const target = randomSelection(this.modelList.models[modelId]);\n            loadlive2d(\"live2d\", `${this.cdnPath}model/${target}/index.json`);\n        } else {\n            loadlive2d(\"live2d\", `${this.apiPath}get/?id=${modelId}-${modelTexturesId}`);\n            console.log(`Live2D 模型 ${modelId}-${modelTexturesId} 加载完成`);\n        }\n    }\n\n    async loadRandModel() {\n        const modelId = localStorage.getItem(\"modelId\"),\n            modelTexturesId = localStorage.getItem(\"modelTexturesId\");\n        if (this.useCDN) {\n            if (!this.modelList) await this.loadModelList();\n            const target = randomSelection(this.modelList.models[modelId]);\n            loadlive2d(\"live2d\", `${this.cdnPath}model/${target}/index.json`);\n            showMessage(\"我的新衣服好看嘛？\", 4000, 10);\n        } else {\n            // 可选 \"rand\"(随机), \"switch\"(顺序)\n            fetch(`${this.apiPath}rand_textures/?id=${modelId}-${modelTexturesId}`)\n                .then(response => response.json())\n                .then(result => {\n                    if (result.textures.id === 1 && (modelTexturesId === 1 || modelTexturesId === 0)) showMessage(\"我还没有其他衣服呢！\", 4000, 10);\n                    else this.loadModel(modelId, result.textures.id, \"我的新衣服好看嘛？\");\n                });\n        }\n    }\n\n    async loadOtherModel() {\n        let modelId = localStorage.getItem(\"modelId\");\n        if (this.useCDN) {\n            if (!this.modelList) await this.loadModelList();\n            const index = (++modelId >= this.modelList.models.length) ? 0 : modelId;\n            this.loadModel(index, 0, this.modelList.messages[index]);\n        } else {\n            fetch(`${this.apiPath}switch/?id=${modelId}`)\n                .then(response => response.json())\n                .then(result => {\n                    this.loadModel(result.model.id, 0, result.model.message);\n                });\n        }\n    }\n}\n\nexport default Model;\n","count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"toc":"","data":[]}