{"title":"图像拼接编程实践","uid":"2f2ae9cabd3d239359b1e3a9dc1dff4f","slug":"图像拼接编程实践","date":"2024-11-13T14:12:35.000Z","updated":"2024-11-13T15:34:39.102Z","comments":true,"path":"api/articles/图像拼接编程实践.json","keywords":null,"cover":"https://s2.loli.net/2024/11/13/IAWbfJXZp9vQPuF.jpg","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>本项目是关于的图像拼接练习，我使用的编程语言是python，是笔者在校系统性学习机器学习的课程小项目，也不是啥新鲜玩意了，GitHub上很多复现的，感兴趣可以去GitHub上多找找。</p>\n<h1 id=\"项目前置\"><a href=\"#项目前置\" class=\"headerlink\" title=\"项目前置\"></a>项目前置</h1><h2 id=\"python版本要求\"><a href=\"#python版本要求\" class=\"headerlink\" title=\"python版本要求\"></a>python版本要求</h2><div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p>python&#x3D;3.x</p>\n\n</div>\n<h2 id=\"库依赖要求\"><a href=\"#库依赖要求\" class=\"headerlink\" title=\"库依赖要求\"></a>库依赖要求</h2><div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p><p>opencv-python<br>stitching<br>numpy &lt;&#x3D; 1.26.4</p>\n</p>\n</div>\n<h1 id=\"要求\"><a href=\"#要求\" class=\"headerlink\" title=\"要求\"></a>要求</h1><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><ol>\n<li>图像采集：使用相机或手机拍摄至少三幅图像。确保这些图像具有重叠部分（重叠区域建议为30%-50%）。建议选择一个具有丰富细节的场景，比如风景、建筑物或室内环境。</li>\n<li>图像预处理：使用图像处理软件（如OpenCV）读取和预处理这些图像；对图像进行畸变校正（如果必要），确保图像质量。</li>\n<li>特征检测与匹配：使用SIFT、ORB等特征检测算法提取图像中的关键点，应用匹配算法找到不同图像之间的特征匹配。</li>\n<li>拼接与合成：将图像进行变换和拼接，创建一幅全景图像。</li>\n</ol></blockquote>\n<h1 id=\"实现过程\"><a href=\"#实现过程\" class=\"headerlink\" title=\"实现过程\"></a>实现过程</h1><p>通过网上查找资料总共有三套多图像拼接的解决方案</p>\n<h2 id=\"使用OpenCV-stitcher类\"><a href=\"#使用OpenCV-stitcher类\" class=\"headerlink\" title=\"使用OpenCV stitcher类\"></a>使用OpenCV stitcher类</h2><h3 id=\"实现思路\"><a href=\"#实现思路\" class=\"headerlink\" title=\"实现思路\"></a>实现思路</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/cbxyrkTfMGjZWzV.png\"></div>\n\n<div align=center>Opencv的Stitcher类的内部逻辑</div>\n\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">这张图展示了 OpenCV Stitcher 类中的图像拼接流程。</p>\n<p>首先，它从一组输入图像开始，将图像调整到中等分辨率，然后在图像中提取特征点并匹配这些特征点，以找到相邻图像之间的重叠区域。接着，程序对相机参数进行初步估计，并通过全局优化来确保图像的精确对齐。同时，还会进行波形校正和全景图的尺度估计，使图像在同一尺度上对齐。<br>在合成阶段，图像经过透视变换后能够在同一平面上对齐，然后系统会自动补偿不同图像之间的曝光差异，计算并修正曝光误差。随后，程序会找到图像的接缝区域，并调整掩码的分辨率以确保无缝融合。<br>最后，对齐后的图像进行融合处理，消除接缝区域的边界痕迹，最终输出一张完整的全景图。整个流程实现了从多张图像生成无缝全景图的功能<br>直接使用stitcher类来生成拼接图像就很简单，速度也很快</p>\n</p>\n</div>\n<h3 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><details class=\"custom-details\">\n<summary>图像加载</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">load_images</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">image_path</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    加载指定路径下的所有图像</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :param image_path: 图像文件夹路径</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :return: 加载的图像列表</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    logging</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">info</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">正在加载图像...</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 获取所有以 .jpg 结尾的图像文件路径</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    image_files </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">osp</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">join</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">image_path</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8\">file</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> file </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">listdir</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">image_path</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> file</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">endswith</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">.jpg</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 读取图像文件</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    images </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">imread</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8\">file</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> file </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> image_files</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 检查是否有图像加载失败</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">any</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img </span><span style=\"color: #89DDFF; font-style: italic\">is</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">None</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #82AAFF\"> img </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #82AAFF\"> images</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">raise</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">ValueError</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">加载图像时出错，请检查图像路径和文件格式。</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> images</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>拼接图像</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">stitch_images</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">images</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    拼接图像</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :param images: 图像列表</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :return: 拼接后的图像</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    logging</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">info</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">正在拼接图像...</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 创建拼接器对象</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    stitcher </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">createStitcher</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> imutils</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">is_cv3</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">else</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">Stitcher_create</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 拼接图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    status</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> stitched </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> stitcher</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">stitch</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">images</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 检查拼接状态</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> status </span><span style=\"color: #89DDFF\">!=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">raise</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">RuntimeError</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #C792EA\">f</span><span style=\"color: #C3E88D\">&quot;图像拼接失败，错误代码：</span><span style=\"color: #F78C6C\">&#123;</span><span style=\"color: #82AAFF\">status</span><span style=\"color: #F78C6C\">&#125;</span><span style=\"color: #C3E88D\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> stitched</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>裁切图片</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">crop_stitched_image</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">stitched</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    裁剪拼接后的图像，去除黑边</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :param stitched: 拼接后的图像</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :return: 裁剪后的图像</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    logging</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">info</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">正在裁剪...</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 在图像周围添加边框</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    stitched </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">copyMakeBorder</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">stitched</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">BORDER_CONSTANT</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">))</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 转换为灰度图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    gray </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">cvtColor</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">stitched</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">COLOR_BGR2GRAY</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 二值化处理</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    thresh </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">threshold</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">gray</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">THRESH_BINARY</span><span style=\"color: #89DDFF\">)[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 查找轮廓</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    cnts </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">findContours</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">thresh</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">copy</span><span style=\"color: #89DDFF\">(),</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">RETR_EXTERNAL</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CHAIN_APPROX_SIMPLE</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    cnts </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> imutils</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">grab_contours</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">cnts</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 获取最大轮廓</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    c </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">max</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">cnts</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">key</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">contourArea</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 创建掩码</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    mask </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> np</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">zeros</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">thresh</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">dtype</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">uint8</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    x</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> y</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> w</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> h </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">boundingRect</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">c</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">rectangle</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">mask</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">x</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> y</span><span style=\"color: #89DDFF\">),</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">x </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #82AAFF\"> w</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> y </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #82AAFF\"> h</span><span style=\"color: #89DDFF\">),</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">-</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    minRect </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> mask</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">copy</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    sub </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> mask</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">copy</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 逐步腐蚀掩码，去除黑边</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">while</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">countNonZero</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">sub</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        minRect </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">erode</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">minRect</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">None)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        sub </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">subtract</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">minRect</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> thresh</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 查找腐蚀后的轮廓</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    cnts </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">findContours</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">minRect</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">copy</span><span style=\"color: #89DDFF\">(),</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">RETR_EXTERNAL</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CHAIN_APPROX_SIMPLE</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    cnts </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> imutils</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">grab_contours</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">cnts</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    c </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">max</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">cnts</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">key</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">contourArea</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    x</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> y</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> w</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> h </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">boundingRect</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">c</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 裁剪图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    stitched </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> stitched</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">y</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\">y </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #BABED8\"> h</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> x</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\">x </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #BABED8\"> w</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> stitched</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>main</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">main</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">args</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    主函数，执行图像拼接和保存</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    :param args: 命令行参数</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\">    </span><span style=\"color: #89DDFF; font-style: italic\">&quot;&quot;&quot;</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #82AAFF\">print</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">output_path</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">try</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 获取当前时间戳</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        timestamp </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> datetime</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">datetime</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">now</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">strftime</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">%Y-%m-</span><span style=\"color: #F78C6C\">%d</span><span style=\"color: #C3E88D\">-%H-%M-%S</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 加载图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        images </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">load_images</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">args</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">images</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 拼接图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        stitched </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">stitch_images</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">images</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 如果需要裁剪拼接图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> args</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">crop</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            stitched </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">crop_stitched_image</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">stitched</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #676E95; font-style: italic\"># 确保输出文件路径包含有效的扩展名</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            valid_extensions </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">.png</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">.jpg</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">.jpeg</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">not</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">any</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">args</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">output</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">lower</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">endswith</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">ext</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #82AAFF\"> ext </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #82AAFF\"> valid_extensions</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                args</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">output</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">path</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">join</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">args</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">output</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #C792EA\">f</span><span style=\"color: #C3E88D\">&#39;stitched_</span><span style=\"color: #F78C6C\">&#123;</span><span style=\"color: #82AAFF\">timestamp</span><span style=\"color: #F78C6C\">&#125;</span><span style=\"color: #C3E88D\">.png&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #82AAFF\">print</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">args</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">output</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 保存拼接后的图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">imwrite</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">args</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">output</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> stitched</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 显示拼接后的图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">imshow</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">Stitched</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> stitched</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">waitKey</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">except</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">Exception</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">as</span><span style=\"color: #BABED8\"> e</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        logging</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">error</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">e</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<h2 id=\"使用stitching库\"><a href=\"#使用stitching库\" class=\"headerlink\" title=\"使用stitching库\"></a>使用stitching库</h2><h3 id=\"实现思路-1\"><a href=\"#实现思路-1\" class=\"headerlink\" title=\"实现思路\"></a>实现思路</h3><p>这个库是我在github上闲逛找到的一个python图像拼接库<a href=\"\">stitching</a></p>\n<div align=center><img src=\"https://s2.loli.net/2024/11/13/9NcyUHjAPzEhYWb.png\"></div>\n\n<p>这也是受 OpenCV stitcher类启发并基于此写出的python包，原理上和openCV差不多。可以通过在conda环境中输入</p>\n<div class=\"language-bash\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">bash</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #FFCB6B\">pip</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">install</span><span style=\"color: #BABED8\"> </span><span style=\"color: #C3E88D\">stitching</span></span></code></pre></div><p>从PyPi上安装该库，通过研读stitching库的API，可以通过简单几行代码实现多图像的拼接</p>\n<h3 id=\"代码实现-1\"><a href=\"#代码实现-1\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><details class=\"custom-details\">\n<summary>only a simple sample</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #89DDFF; font-style: italic\">from</span><span style=\"color: #BABED8\"> stitching </span><span style=\"color: #89DDFF; font-style: italic\">import</span><span style=\"color: #BABED8\"> Stitcher</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF; font-style: italic\">import</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">path</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">as</span><span style=\"color: #BABED8\"> osp</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF; font-style: italic\">import</span><span style=\"color: #BABED8\"> os</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF; font-style: italic\">import</span><span style=\"color: #BABED8\"> cv2</span></span>\n<span class=\"line\"><span style=\"color: #89DDFF; font-style: italic\">import</span><span style=\"color: #BABED8\"> datetime</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">script_path </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> osp</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">dirname</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">osp</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">abspath</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8\">__file__</span><span style=\"color: #89DDFF\">))</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">project_path </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> osp</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">dirname</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">script_path</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">image_path </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> osp</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">join</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">project_path</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">images</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">output_path </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> osp</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">join</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">project_path</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">output</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">images </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">imread</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">osp</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">join</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">image_path</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8\">file</span><span style=\"color: #89DDFF\">))</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> file </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> os</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">listdir</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">image_path</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> file</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">endswith</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #C3E88D\">.jpg</span><span style=\"color: #89DDFF\">&#39;</span><span style=\"color: #89DDFF\">)]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">stitcher </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">Stitcher</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">stitcher </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">Stitcher</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">detector</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">sift</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">confidence_threshold</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">0.3</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">timestamp </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> datetime</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">datetime</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">now</span><span style=\"color: #89DDFF\">().</span><span style=\"color: #82AAFF\">strftime</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">%Y-%m-</span><span style=\"color: #F78C6C\">%d</span><span style=\"color: #C3E88D\">-%H-%M-%S</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">panorama </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> stitcher</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">stitch</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">images</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">imwrite</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">output_path </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #C792EA\">f</span><span style=\"color: #C3E88D\">&#39;/stitched_</span><span style=\"color: #F78C6C\">&#123;</span><span style=\"color: #82AAFF\">timestamp</span><span style=\"color: #F78C6C\">&#125;</span><span style=\"color: #C3E88D\">.png&#39;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> panorama</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">print</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">Panorama save</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">imshow</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">Panorama</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> panorama</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">waitKey</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">destroyAllWindows</span><span style=\"color: #89DDFF\">()</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<h2 id=\"半手搓复现stitch\"><a href=\"#半手搓复现stitch\" class=\"headerlink\" title=\"半手搓复现stitch\"></a>半手搓复现stitch</h2><p>调OpenCV的一些检测与计算算法</p>\n<h3 id=\"实现思路-2\"><a href=\"#实现思路-2\" class=\"headerlink\" title=\"实现思路\"></a>实现思路</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/52dJl4pH6L1PQD9.png\"></div>\n\n<div align=center>复现的stitch类流程图</div>\n\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">我的复现流程分为3个步骤</p>\n<ol>\n<li>图像预处理：首先加载需要拼接的图像，通过 SIFT提取每张图像的特征点。使用FLANN进行特征点的匹配，找到相邻图像之间的匹配点。</li>\n<li>图像变换计算与拼接准备：利用匹配点计算单应性矩阵 H，应用 RANSAC 算法来筛选出最佳变换模型，将变换后的图像通过多张图像的融合拼接成一个整体，对拼接图像进行边缘处理，去除边界的黑边，使得拼接区域更平滑，调整图像的曝光以保持整体亮度的一致性</li>\n<li>图像融合：使用多频段融合消除图像交界处的拼接痕迹</li>\n</ol>\n\n</div>\n<h3 id=\"代码实现-2\"><a href=\"#代码实现-2\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><details class=\"custom-details\">\n<summary>复现的关键点检测</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">detect_and_compute</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">img</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 使用SIFT检测关键点并计算描述符</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    sift </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">SIFT_create</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">nfeatures</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">nOctaveLayers</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">3</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">contrastThreshold</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">0.04</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">edgeThreshold</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">10</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">sigma</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">1.6</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    kp</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> des </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> sift</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">detectAndCompute</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">None)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> kp</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> des</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>复现的关键点匹配</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">match_features</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">des1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">des2</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 使用FLANN匹配器匹配特征点描述符</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    FLANN_INDEX_KDTREE </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">0</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    indexParams </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">dict</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">algorithm</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #82AAFF\">FLANN_INDEX_KDTREE</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">trees</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">4</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    searchParams </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">dict</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8; font-style: italic\">checks</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">32</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    flann </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">FlannBasedMatcher</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">indexParams</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> searchParams</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    matches </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> flann</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">knnMatch</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">des1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> des2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #BABED8; font-style: italic\">k</span><span style=\"color: #89DDFF\">=</span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #676E95; font-style: italic\"># k=2表示返回两个最近邻</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 应用Lowe&#39;s ratio test，筛选出好的匹配</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    good_matches </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">m </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> m</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> n </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> matches </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> m</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">distance</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">0.6</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">*</span><span style=\"color: #BABED8\"> n</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">distance</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> good_matches</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>复现的计算单应性矩阵与透视变换</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">find_homography</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">kp1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">kp2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">good_matches</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 计算单应矩阵</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    src_pts </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> np</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">float32</span><span style=\"color: #89DDFF\">([</span><span style=\"color: #82AAFF\">kp1</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #82AAFF\">m</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">queryIdx</span><span style=\"color: #89DDFF\">].</span><span style=\"color: #F07178\">pt</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #82AAFF\"> m </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #82AAFF\"> good_matches</span><span style=\"color: #89DDFF\">]).</span><span style=\"color: #82AAFF\">reshape</span><span style=\"color: #89DDFF\">(-</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    dst_pts </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> np</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">float32</span><span style=\"color: #89DDFF\">([</span><span style=\"color: #82AAFF\">kp2</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #82AAFF\">m</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">trainIdx</span><span style=\"color: #89DDFF\">].</span><span style=\"color: #F07178\">pt</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #82AAFF\"> m </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #82AAFF\"> good_matches</span><span style=\"color: #89DDFF\">]).</span><span style=\"color: #82AAFF\">reshape</span><span style=\"color: #89DDFF\">(-</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    M</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> mask </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">findHomography</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">dst_pts</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> src_pts</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">RANSAC</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">5.0</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> M</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">warp_image</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">img</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">M</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">dsize</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 应用透视变换，得到变换后的图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">warpPerspective</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> M</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> dsize</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>复现的去除图像边缘黑边</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">remove_black_borders</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">img</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 去除图像中的黑边</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    gray </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">cvtColor</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">COLOR_BGR2GRAY</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    _</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> thresh </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">threshold</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">gray</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">THRESH_BINARY</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    contours</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> _ </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">findContours</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">thresh</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">RETR_EXTERNAL</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">CHAIN_APPROX_SIMPLE</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    x</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> y</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> w</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> h </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">boundingRect</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">contours</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">])</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 裁剪图像，去除黑边</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> img</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">y</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\">y</span><span style=\"color: #89DDFF\">+</span><span style=\"color: #BABED8\">h</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> x</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\">x</span><span style=\"color: #89DDFF\">+</span><span style=\"color: #BABED8\">w</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>复现的图像重叠区域优化</summary>\n<p><div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #676E95; font-style: italic\"># 采用重叠区域加权平均的算法，会有缺点</span></span>\n<span class=\"line\"><span style=\"color: #676E95; font-style: italic\"># 可以加入曝光补偿来优化拼接处的色彩不连续</span></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">optimize_stitching</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">warpImg</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">img1</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 优化拼接，处理重叠区域</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    rows</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> cols </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> img1</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">[:</span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    left </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">0</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    right </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> cols</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 找到重叠区域的左边界</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> col </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">range</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cols</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> img1</span><span style=\"color: #89DDFF\">[:,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">].</span><span style=\"color: #82AAFF\">any</span><span style=\"color: #89DDFF\">()</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">and</span><span style=\"color: #BABED8\"> warpImg</span><span style=\"color: #89DDFF\">[:,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">].</span><span style=\"color: #82AAFF\">any</span><span style=\"color: #89DDFF\">():</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            left </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> col</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF; font-style: italic\">break</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    res </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> np</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">zeros</span><span style=\"color: #89DDFF\">([</span><span style=\"color: #82AAFF\">rows</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> cols</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">3</span><span style=\"color: #89DDFF\">],</span><span style=\"color: #82AAFF\"> np</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">uint8</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> row </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">range</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> rows</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> col </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">range</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> right</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">not</span><span style=\"color: #BABED8\"> img1</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">].</span><span style=\"color: #82AAFF\">any</span><span style=\"color: #89DDFF\">():</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #676E95; font-style: italic\"># 如果img1在该像素为黑色，使用warpImg的像素</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                res</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> warpImg</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF; font-style: italic\">elif</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">not</span><span style=\"color: #BABED8\"> warpImg</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">].</span><span style=\"color: #82AAFF\">any</span><span style=\"color: #89DDFF\">():</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #676E95; font-style: italic\"># 如果warpImg在该像素为黑色，使用img1的像素</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                res</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> img1</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">            </span><span style=\"color: #89DDFF; font-style: italic\">else</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                </span><span style=\"color: #676E95; font-style: italic\"># 对重叠区域进行加权平均</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                srcImgLen </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">float</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">abs</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">col </span><span style=\"color: #89DDFF\">-</span><span style=\"color: #82AAFF\"> left</span><span style=\"color: #89DDFF\">))</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                testImgLen </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> </span><span style=\"color: #FFCB6B\">float</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">abs</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">col </span><span style=\"color: #89DDFF\">-</span><span style=\"color: #82AAFF\"> right</span><span style=\"color: #89DDFF\">))</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                alpha </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> srcImgLen </span><span style=\"color: #89DDFF\">/</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #BABED8\">srcImgLen </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #BABED8\"> testImgLen</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">                res</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #BABED8\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> col</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> np</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">clip</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img1</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #82AAFF\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> col</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">*</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">-</span><span style=\"color: #82AAFF\"> alpha</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #82AAFF\"> warpImg</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #82AAFF\">row</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> col</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">*</span><span style=\"color: #82AAFF\"> alpha</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #F78C6C\">255</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    warpImg</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\">img1</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">],</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">:</span><span style=\"color: #BABED8\">img1</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">]]</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> res</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">return</span><span style=\"color: #BABED8\"> warpImg</span></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<details class=\"custom-details\">\n<summary>复现的多图像拼接</summary>\n<p><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>我复现的多图像拼接的本质还是做双图像的拼接，好处是处理起来简单，坏处是遇到很多的图像的时候拼接效果会畸变会很严重导致效果很差，这其实也是0几年算法的缺陷，仅仅对一张图片做单应性矩阵的运算，然后只进行一次的透射变换，视差一大必然导致畸变放大，单次的透射变换复杂度不够描述一些关键点对应关系比较复杂的图像拼接，而且这种定下来一个主图其他图仿射变换到其上的拼接方式会导致很严重的误差累积，在一张一张分别处理拼接的时候。</p></blockquote>\n<div class=\"language-python\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">python</span><pre class=\"shiki material-theme-palenight\" style=\"background-color: #1a1a1a\" tabindex=\"0\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">stitch_images</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">img1_path</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">img2_path</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 拼接两张图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    img1 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">read_image</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img1_path</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    img2 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">read_image</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img2_path</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    kp1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> des1 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">detect_and_compute</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img1</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    kp2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> des2 </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">detect_and_compute</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img2</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    good_matches </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">match_features</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">des1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> des2</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">len</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">good_matches</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&gt;</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">min_matches</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 计算单应矩阵</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        M </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">find_homography</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">kp1</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> kp2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> good_matches</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 应用透视变换</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        warpImg </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">warp_image</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img2</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> M</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img1</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #82AAFF\"> img2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">],</span></span>\n<span class=\"line\"><span style=\"color: #82AAFF\">                                                max</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">],</span><span style=\"color: #82AAFF\"> img1</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #F07178\">shape</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">])))</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 优化拼接</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        optimize </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">optimize_stitching</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">warpImg</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> img1</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 去除黑边</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        optimize </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">remove_black_borders</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">optimize</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 保存并显示结果</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        cv2</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">imwrite</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">img1_path</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">split</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">.jpg</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #82AAFF\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">optimize.png</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> optimize</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #82AAFF\">print</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">result saved!</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\">#cv2.imshow(&quot;result&quot;, optimize)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\">#cv2.waitKey(0)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\">#cv2.destroyAllWindows()</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">else</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #82AAFF\">print</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">not enough matches!</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #C792EA\">def</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">stitch_multiple_images</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #F07178; font-style: italic\">self</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #BABED8\"> </span><span style=\"color: #BABED8; font-style: italic\">image_paths</span><span style=\"color: #89DDFF\">):</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #676E95; font-style: italic\"># 拼接多张图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">if</span><span style=\"color: #BABED8\"> </span><span style=\"color: #82AAFF\">len</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">image_paths</span><span style=\"color: #89DDFF\">)</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&lt;</span><span style=\"color: #BABED8\"> </span><span style=\"color: #F78C6C\">2</span><span style=\"color: #89DDFF\">:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #82AAFF\">print</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">需要至少两张图像进行拼接</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #89DDFF; font-style: italic\">return</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    base_image_path </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> image_paths</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">]</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">    </span><span style=\"color: #89DDFF; font-style: italic\">for</span><span style=\"color: #BABED8\"> next_image_path </span><span style=\"color: #89DDFF; font-style: italic\">in</span><span style=\"color: #BABED8\"> image_paths</span><span style=\"color: #89DDFF\">[</span><span style=\"color: #F78C6C\">1</span><span style=\"color: #89DDFF\">:]:</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 逐步拼接图像</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        self</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">stitch_images</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #82AAFF\">base_image_path</span><span style=\"color: #89DDFF\">,</span><span style=\"color: #82AAFF\"> next_image_path</span><span style=\"color: #89DDFF\">)</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        </span><span style=\"color: #676E95; font-style: italic\"># 更新基准图像为上一次的拼接结果</span></span>\n<span class=\"line\"><span style=\"color: #BABED8\">        base_image_path </span><span style=\"color: #89DDFF\">=</span><span style=\"color: #BABED8\"> base_image_path</span><span style=\"color: #89DDFF\">.</span><span style=\"color: #82AAFF\">split</span><span style=\"color: #89DDFF\">(</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">.jpg</span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #89DDFF\">)[</span><span style=\"color: #F78C6C\">0</span><span style=\"color: #89DDFF\">]</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">+</span><span style=\"color: #BABED8\"> </span><span style=\"color: #89DDFF\">&quot;</span><span style=\"color: #C3E88D\">optimize.png</span><span style=\"color: #89DDFF\">&quot;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"></span></code></pre></div></p>\n</details>\n<h1 id=\"测试结果\"><a href=\"#测试结果\" class=\"headerlink\" title=\"测试结果\"></a>测试结果</h1><h2 id=\"使用images-a数据集\"><a href=\"#使用images-a数据集\" class=\"headerlink\" title=\"使用images_a数据集\"></a>使用images_a数据集</h2><p>7张图片小视差数据集，每张图片之间的重叠区域在70%~80%左右，</p>\n<h3 id=\"OpenCV-stitcher实现\"><a href=\"#OpenCV-stitcher实现\" class=\"headerlink\" title=\"OpenCV stitcher实现\"></a>OpenCV stitcher实现</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/vY1smtVMSAEr6Ud.png\"></div>\n\n<p>OpenCV stitcher类底层是由C++实现的在加上算法优化可以保证5秒钟之内融合出图，速度特别快，但是由于其会使边缘变形较为严重，截成矩形图像后保存的拼接图看起来会比较短。</p>\n<h3 id=\"stitching库实现\"><a href=\"#stitching库实现\" class=\"headerlink\" title=\"stitching库实现\"></a>stitching库实现</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/RjUcPX3YV2MW1rL.png\"></div>\n\n<p>生成速度也比较快，估计在7秒左右，图片的调教做的不错，边缘处理变形不大，可以保留大部分边缘信息完好，但是在多张图像重叠区域还是会出现一点模糊的情况。</p>\n<h3 id=\"复现stitch\"><a href=\"#复现stitch\" class=\"headerlink\" title=\"复现stitch\"></a>复现stitch</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/K2Lc4eV5vquOrIX.png\"></div>\n\n<p>自己写的拼接生成拼接图片的速度比较慢，在2022年的拯救者r9000p笔记本上2分钟左右才能跑出来，而且会产生鬼影，重叠区域处理采用最简单的加权处理就会产生这种问题。</p>\n<h2 id=\"使用images-b数据集\"><a href=\"#使用images-b数据集\" class=\"headerlink\" title=\"使用images_b数据集\"></a>使用images_b数据集</h2><p>7张图片大视差数据集，每张图片之间的重叠区域在40%~50%左右<br>由于视差比较大，三种方法出来的图畸变都很严重</p>\n<h3 id=\"OpenCV-stitcher实现-1\"><a href=\"#OpenCV-stitcher实现-1\" class=\"headerlink\" title=\"OpenCV stitcher实现\"></a>OpenCV stitcher实现</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/8J3bZVzHeIltUnk.png\"></div>\n\n<p>由于严重的变形，前面的部分都被截掉了。</p>\n<h3 id=\"stitching库实现-1\"><a href=\"#stitching库实现-1\" class=\"headerlink\" title=\"stitching库实现\"></a>stitching库实现</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/iT6upEQjhZYyAsx.png\"></div>\n\n<p>整体最像一张全景图，但是中间的连接处不够平滑，有突变。</p>\n<h3 id=\"复现stitch-1\"><a href=\"#复现stitch-1\" class=\"headerlink\" title=\"复现stitch\"></a>复现stitch</h3><div align=center><img src=\"https://s2.loli.net/2024/11/13/Jgl4xhyLzBaMG9p.png\"></div>\n\n<p>视差太大，我自己写的算法仅仅只是对一整个图像做单次的单应性矩阵的透视变换，仅仅做了线性变换每次都矫正的不够彻底，每次做变换都会导致误差累积，最后只融合了4张图就不够关键点匹配了。边缘的鬼影问题还是照旧。</p>\n<h2 id=\"目前想到的优化方案\"><a href=\"#目前想到的优化方案\" class=\"headerlink\" title=\"目前想到的优化方案\"></a>目前想到的优化方案</h2><div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">TIP</p>\n<p><strong>(1)</strong> 采用2013年CVPR的APAP算法的思想，采用网格分割，每个网格分别应用局部单应性矩阵，得到曲面的拼接图，但是这需要的算力会变大，运算时间会上升。</p>\n<div align=center><img src=\"https://s2.loli.net/2024/11/13/87xtUj2vJRPkcqd.png\"></div>\n\n<div align=center>As-Projective-As-Possible Image Stitching with Moving DLT</div>\n\n<p><strong>(2)</strong> 减少使用for循环多使用numpy，增加并行运算提高运算效率。</p>\n\n</div>\n<h1 id=\"心得与体会\"><a href=\"#心得与体会\" class=\"headerlink\" title=\"心得与体会\"></a>心得与体会</h1><div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">总结 </p>\n<p><p>通过这次图像拼接的课程作业，我深入学习并实践了图像拼接的核心流程，包括图像特征提取、匹配、变换计算以及图像融合等关键技术。在实现过程中，我使用了 OpenCV 的 Stitcher 类和 stitching 库，并尝试复现拼接算法，从中获得了许多收获。<br>首先，通过使用 OpenCV 的 Stitcher 类，我体会到基于已有库的实现优势。这种方法速度快、效果较好，尤其是在小视差的场景下，可以高效地生成质量不错的全景图。Stitcher 类内部的优化算法让拼接过程变得简单，同时避免了许多细节上的困难。不过，OpenCV 拼接的边缘变形问题在一些场景下仍然较明显，需要进一步裁剪和调整。<br>在尝试 stitching 库的过程中，我发现这类开源库通过 Python API 进行了更高层次的封装，使得代码实现更加便捷。尽管效果与 OpenCV 类似，但在多图像拼接时，该库在保留边缘细节方面表现稍好，尤其是对中等视差场景的拼接有一定优势。不过，拼接处可能会出现模糊的问题。<br>最后，通过复现 Stitcher 类，我在算法的实现细节上加深了理解。通过手动编写特征提取、匹配、单应性计算和图像融合的过程，我掌握了拼接算法的关键步骤。然而，自实现算法的效率较低，尤其在大视差情况下，由于误差累积，拼接效果不够理想，甚至出现了鬼影和边缘重叠的现象。这一过程让我意识到精确控制参数、使用更高效的算法（如 APAP 局部单应性算法）和提升计算效率的重要性。</p>\n</p>\n</div>\n<hr>\n<div class=\"custom-quote warning\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 8V13\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12 15.99V16.01\"></path>\n</svg>\n</span>\n<p class=\"custom-quote-title\">未来展望</p>\n<p>由于iphone的相机软件也有产生全景图的功能，我希望之后能通过优化算法实现实时的图像拼接，然后再使用相机（或手机）实时采图，也做出这种效果。</p>\n<div align=center><img src=\"https://s2.loli.net/2024/11/13/1bcXfLRlVj9Z45I.png\"></div>\n\n\n</div>\n","text":"前言本项目是关于的图像拼接练习，我使用的编程语言是python，是笔者在校系统性学习机器学习的课程小项目，也不是啥新鲜玩意了，GitHub上很多复现的，感兴趣可...","permalink":"/post/图像拼接编程实践","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[{"name":"MashineLearning","slug":"MashineLearning","count":3,"path":"api/categories/MashineLearning.json"}],"tags":[{"name":"python","slug":"python","count":5,"path":"api/tags/python.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">前言</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E9%A1%B9%E7%9B%AE%E5%89%8D%E7%BD%AE\"><span class=\"toc-text\">项目前置</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#python%E7%89%88%E6%9C%AC%E8%A6%81%E6%B1%82\"><span class=\"toc-text\">python版本要求</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%BA%93%E4%BE%9D%E8%B5%96%E8%A6%81%E6%B1%82\"><span class=\"toc-text\">库依赖要求</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E8%A6%81%E6%B1%82\"><span class=\"toc-text\">要求</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B\"><span class=\"toc-text\">实现过程</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8OpenCV-stitcher%E7%B1%BB\"><span class=\"toc-text\">使用OpenCV stitcher类</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF\"><span class=\"toc-text\">实现思路</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">代码实现</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8stitching%E5%BA%93\"><span class=\"toc-text\">使用stitching库</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-1\"><span class=\"toc-text\">实现思路</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-1\"><span class=\"toc-text\">代码实现</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8D%8A%E6%89%8B%E6%90%93%E5%A4%8D%E7%8E%B0stitch\"><span class=\"toc-text\">半手搓复现stitch</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-2\"><span class=\"toc-text\">实现思路</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0-2\"><span class=\"toc-text\">代码实现</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C\"><span class=\"toc-text\">测试结果</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8images-a%E6%95%B0%E6%8D%AE%E9%9B%86\"><span class=\"toc-text\">使用images_a数据集</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#OpenCV-stitcher%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">OpenCV stitcher实现</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#stitching%E5%BA%93%E5%AE%9E%E7%8E%B0\"><span class=\"toc-text\">stitching库实现</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%A4%8D%E7%8E%B0stitch\"><span class=\"toc-text\">复现stitch</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BD%BF%E7%94%A8images-b%E6%95%B0%E6%8D%AE%E9%9B%86\"><span class=\"toc-text\">使用images_b数据集</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#OpenCV-stitcher%E5%AE%9E%E7%8E%B0-1\"><span class=\"toc-text\">OpenCV stitcher实现</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#stitching%E5%BA%93%E5%AE%9E%E7%8E%B0-1\"><span class=\"toc-text\">stitching库实现</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%A4%8D%E7%8E%B0stitch-1\"><span class=\"toc-text\">复现stitch</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%9B%AE%E5%89%8D%E6%83%B3%E5%88%B0%E7%9A%84%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88\"><span class=\"toc-text\">目前想到的优化方案</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%BF%83%E5%BE%97%E4%B8%8E%E4%BD%93%E4%BC%9A\"><span class=\"toc-text\">心得与体会</span></a></li></ol>","author":{"name":"Yesord","slug":"blog-author","avatar":"/img/avatar/Flametail.gif","link":"/","description":"猫军阀军校的一个三年级学牲。","socials":{"github":"https://github.com/Yesord","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/aoliba_believer","juejin":"","customs":{"Home":{"icon":"/img/Home.svg","link":"https://home.yesord.top/about/"},"Academic":{"icon":"/img/Academic.svg","link":"https://academic.yesord.top"},"Travelling":{"icon":"/img/train.svg","link":"https://www.travellings.cn/go.html"}}}},"mapped":true,"hidden":false,"prev_post":{"title":"光学设计资料整合","uid":"d05ea03e60dbacb8a8e193106dfdc2a8","slug":"光学设计资料整合","date":"2024-11-18T14:46:59.000Z","updated":"2024-12-07T08:18:43.034Z","comments":true,"path":"api/articles/光学设计资料整合.json","keywords":null,"cover":"https://s2.loli.net/2024/11/12/3kVvYA1CGDMKchE.jpg","text":"前言本文主要记载我在入门光学设计所看到的有帮助的帖子 帖子 ZEMAX光学设计—单透镜（a singlet） ZEMAX光学设计实例（2）—双透镜（a doub...","permalink":"/post/光学设计资料整合","photos":[],"count_time":{"symbolsCount":327,"symbolsTime":"1 mins."},"categories":[{"name":"Optic Design","slug":"Optic-Design","count":4,"path":"api/categories/Optic-Design.json"}],"tags":[{"name":"Zemax","slug":"Zemax","count":4,"path":"api/tags/Zemax.json"}],"author":{"name":"Yesord","slug":"blog-author","avatar":"/img/avatar/Flametail.gif","link":"/","description":"猫军阀军校的一个三年级学牲。","socials":{"github":"https://github.com/Yesord","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/aoliba_believer","juejin":"","customs":{"Home":{"icon":"/img/Home.svg","link":"https://home.yesord.top/about/"},"Academic":{"icon":"/img/Academic.svg","link":"https://academic.yesord.top"},"Travelling":{"icon":"/img/train.svg","link":"https://www.travellings.cn/go.html"}}}}},"next_post":{"title":"光学设计入门（一）——牛顿反射式望远镜设计","uid":"4bc11b96bc151d97b948e3471f93512a","slug":"光学设计入门（一）——牛顿反射式望远镜设计","date":"2024-11-12T15:22:20.000Z","updated":"2024-11-13T14:23:56.907Z","comments":true,"path":"api/articles/光学设计入门（一）——牛顿反射式望远镜设计.json","keywords":null,"cover":"https://s2.loli.net/2024/11/12/TWHouyhFiU28SC3.jpg","text":"前言我们使用的光学设计软件是Zemax，这是光学设计的入门软件，比较简单，优化参数相对CodeV没那么多。 这是Zemax2005版 现在的Zemax已经被An...","permalink":"/post/光学设计入门（一）——牛顿反射式望远镜设计","photos":[],"count_time":{"symbolsCount":"3.1k","symbolsTime":"3 mins."},"categories":[{"name":"Optic Design","slug":"Optic-Design","count":4,"path":"api/categories/Optic-Design.json"}],"tags":[{"name":"Zemax","slug":"Zemax","count":4,"path":"api/tags/Zemax.json"}],"author":{"name":"Yesord","slug":"blog-author","avatar":"/img/avatar/Flametail.gif","link":"/","description":"猫军阀军校的一个三年级学牲。","socials":{"github":"https://github.com/Yesord","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"https://blog.csdn.net/aoliba_believer","juejin":"","customs":{"Home":{"icon":"/img/Home.svg","link":"https://home.yesord.top/about/"},"Academic":{"icon":"/img/Academic.svg","link":"https://academic.yesord.top"},"Travelling":{"icon":"/img/train.svg","link":"https://www.travellings.cn/go.html"}}}}}}